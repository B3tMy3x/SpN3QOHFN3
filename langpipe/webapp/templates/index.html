{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col card">
    <h3>Конфигурация</h3>
    <label>Trino JDBC URL</label>
    <input id="jdbc" placeholder="jdbc:trino://..." />
    <button onclick="saveTrino()">Сохранить Trino</button>
    <label>Модель</label>
    <select id="model">
      <option value="local">Локальная</option>
      <option value="openrouter">OpenRouter</option>
      <option value="ollama">Ollama</option>
    </select>
    <label>OpenRouter модель</label>
    <input id="openrouter_model" placeholder="deepseek/deepseek-coder:6.7b-instruct" />
    <label>Ollama base URL</label>
    <input id="ollama_base" placeholder="https://ollama.m1r0.ru" />
    <label>Ollama модель</label>
    <input id="ollama_model" placeholder="gpt-oss:latest" />
    <label><input type="checkbox" id="trino_safe_mode" /> Безопасный режим Trino (только SELECT/WITH + LIMIT)</label>
    <button onclick="saveModel()">Сохранить модель</button>
  </div>
  <div class="col card">
    <h3>Быстрый старт</h3>
    <p class="muted">Перейдите на вкладки для конкретных сценариев: одиночный, пара, очередь.</p>
    <p>Журнал всех запусков смотрите на странице «Джобы».</p>
  </div>
  <div class="col card">
    <h3>Выдержка API</h3>
    <ul>
      <li>POST <code>/run/single</code>, <code>/run/pair</code></li>
      <li>GET/POST <code>/queues/*</code>, GET <code>/jobs/{id}</code></li>
    </ul>
  </div>
  <div class="col card">
    <h3>Вывод</h3>
    <pre id="out"></pre>
  </div>
  <div class="col card">
    <h3>Последние джобы</h3>
    <pre id="feed"></pre>
  </div>
  <div class="col">
  </div>
  <script>
    async function getConfig(){const r=await fetch('/config');return await r.json();}
    function $(id){return document.getElementById(id);} 
    async function init(){const c=await getConfig();$('jdbc').value=c.jdbc_url||'';$('model').value=c.model_mode||'local';$('openrouter_model').value=c.openrouter_model||'';$('ollama_base').value=c.ollama_base||'';$('ollama_model').value=c.ollama_model||'';$('trino_safe_mode').checked=!!c.trino_safe_mode; pollFeed();}
    async function saveModel(){const f=new FormData();f.append('mode',$('model').value);f.append('openrouter_model',$('openrouter_model').value);f.append('ollama_base',$('ollama_base').value);f.append('ollama_model',$('ollama_model').value);const r=await fetch('/config/model',{method:'POST',body:f});$('out').textContent=JSON.stringify(await r.json(),null,2);} 
    document.getElementById('trino_safe_mode').addEventListener('change', async (e)=>{const f=new FormData();f.append('safe_mode', e.target.checked ? 'true' : 'false'); const r=await fetch('/config/trino_safety',{method:'POST',body:f}); $('out').textContent=JSON.stringify(await r.json(),null,2);});
    async function saveTrino(){const f=new FormData();f.append('jdbc_url',$('jdbc').value);const r=await fetch('/config/trino',{method:'POST',body:f});$('out').textContent=JSON.stringify(await r.json(),null,2);} 
    async function pollFeed(){const r=await fetch('/jobs/feed');const j=await r.json();$('feed').textContent=JSON.stringify(j,null,2);setTimeout(pollFeed,1500);} 
    window.addEventListener('DOMContentLoaded',init);
  </script>
</div>
{% endblock %}
