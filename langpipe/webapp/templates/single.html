{% extends "base.html" %}
{% block content %}
<div class="row">
  <div class="col card">
    <h3>Одиночный запрос</h3>
    <textarea id="sql" placeholder="SELECT ..."></textarea>
    <label><input type="checkbox" id="optimize" /> Прогон через пайплайн (оптимизация)</label>
    <button id="btn" onclick="runSingle()">Выполнить</button>
    <div id="status" class="muted"></div>
  </div>
  <div class="col card">
    <h3>Результат</h3>
    <pre id="out"></pre>
  </div>
</div>
<script>
  function $(id){return document.getElementById(id);} 
  async function runSingle(){
    const f=new FormData();
    f.append('sql',$('sql').value);
    f.append('optimize',$('optimize').checked?'true':'false');
    $('btn').disabled=true; $('status').textContent='Выполняется…';
    const r=await fetch('/run/single',{method:'POST',body:f});
    const j=await r.json();
    $('out').textContent=JSON.stringify(j,null,2);
    $('btn').disabled=false; $('status').textContent='Готово';
    if(j.job_id){ pollJob(j.job_id); }
  }
  async function pollJob(id){
    const r=await fetch(`/jobs/${id}`);
    if(r.status!==200) return;
    const j=await r.json();
    const done=j.done||0, total=j.total||0, st=j.status||'';
    $('status').textContent = `Статус: ${st} (${done}/${total})`;
    if(st!=='finished') setTimeout(()=>pollJob(id), 800);
  }
</script>
{% endblock %}
