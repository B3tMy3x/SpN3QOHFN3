{% extends "base.html" %}
{% block content %}
<div class="card">
  <h3>Джоба {{ job_id }}</h3>
  <div id="meta" class="muted"></div>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Статус</th>
        <th>Ориг. время (мс)</th>
        <th>Опт. время (мс)</th>
        <th>Δ (мс)</th>
        <th>x = A/T</th>
        <th>y = S/C</th>
        <th>z = x^(1/3)·y</th>
        <th>Δ% времени</th>
        <th>Совпадение</th>
        <th>Строки L/R</th>
        <th>Схема</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
  <h4>Детали</h4>
  <pre id="details"></pre>
  <h4>Шаги пайплайна</h4>
  <div id="steps"></div>
  <h4>Запросы</h4>
  <div>
    <button onclick="toggleBox('left_sql_box')">Оригинальный SQL</button>
    <pre id="left_sql_box" style="display:none"></pre>
    <button onclick="toggleBox('right_sql_box')">Альтернативный SQL</button>
    <pre id="right_sql_box" style="display:none"></pre>
  </div>
  <h4>Результаты</h4>
  <div>
    <button onclick="toggleBox('original_box')">Оригинальный результат</button>
    <pre id="original_box" style="display:none"></pre>
    <button onclick="toggleBox('optimized_box')">Оптимизированный результат</button>
    <pre id="optimized_box" style="display:none"></pre>
    <button onclick="toggleBox('retry_box')">Результат повтора</button>
    <pre id="retry_box" style="display:none"></pre>
    <button onclick="toggleBox('left_box')">Левый (pair)</button>
    <pre id="left_box" style="display:none"></pre>
    <button onclick="toggleBox('right_box')">Правый (pair)</button>
    <pre id="right_box" style="display:none"></pre>
    <button onclick="toggleBox('compare_box')">Сравнение</button>
    <pre id="compare_box" style="display:none"></pre>
  </div>
</div>
<script>
  const jobId = '{{ job_id }}';
  function $(id){return document.getElementById(id);} 
  function cell(text, cls=''){return `<td class="${cls}">${text}</td>`}
  function fmt(v){return (v===undefined||v===null)?'':String(v)}
  function statusFor(item){
    if(item.original?.error) return 'Ошибка (ориг)';
    if(item.optimized?.error) return 'Ошибка (опт)';
    if(item.compare){ return item.compare.match ? 'OK' : 'Mismatch'; }
    return 'OK';
  }
  function clsFor(item){
    if(item.original?.error || item.optimized?.error) return 'err';
    if(item.compare && !item.compare.match) return 'warn';
    return 'ok';
  }
  function deltaClass(d){ if(d==='') return ''; if(d<0) return 'delta-good'; if(d>0) return 'delta-bad'; return 'delta-zero'; }
  function render(job){
    // Fallback compute x(job) client-side if absent
    let xJob = (job.metrics && job.metrics.x!=null) ? Number(job.metrics.x) : null;
    if (xJob==null && Array.isArray(job.progress)){
      let sumQ = 0.0, sumQA_over_T = 0.0;
      job.progress.forEach(it => {
        const left = it.left || it.original || {};
        const right = it.right || it.optimized || it.retry || {};
        const A = (left && typeof left.ms==='number') ? left.ms : null;
        const T = (right && typeof right.ms==='number') ? right.ms : null;
        const Q = (it.meta && it.meta.q!=null) ? Number(it.meta.q) : 1.0;
        if (A!=null && T!=null && T>0){ sumQA_over_T += Q * (A / T); sumQ += Q; }
      });
      if (sumQ>0){ xJob = sumQA_over_T / sumQ; }
    }
    const xOverall = (xJob!=null && !isNaN(xJob)) ? ` | x(job)=${xJob.toFixed(3)}` : '';
    $('meta').textContent = `Статус: ${job.status} | Готово: ${job.done}/${job.total} | Опт: ${job.optimize?'да':'нет'}${xOverall}`;
    const rows = $('rows'); rows.innerHTML='';
    (job.progress||[]).forEach(it => {
      // Support three shapes: single (original/optimized), retry, and pair (left/right)
      const isPair = !!(it.left && it.right);
      const left = isPair ? it.left : (it.original || {});
      const right = isPair ? it.right : (it.optimized || it.retry || {});
      const cmp = it.compare||{};
      function timeLabel(obj){
        if(!obj || !obj.result) return '';
        const tri = obj.result.trino || {};
        if(tri && tri.cpu_ms != null) return 'cpu';
        if(tri && tri.execution_ms != null) return 'exec';
        if(tri && tri.elapsed_ms != null) return 'elapsed';
        return 'client';
      }
      const ms1 = (left && typeof left.ms!== 'undefined') ? `${left.ms} (${timeLabel(left)})` : '';
      const ms2 = (right && typeof right.ms!== 'undefined') ? `${right.ms} (${timeLabel(right)})` : '';
      const delta = (left && right && typeof left.ms==='number' && typeof right.ms==='number') ? (right.ms - left.ms) : '';
      const match = (cmp && cmp.match===true)?'✓':(cmp && cmp.match===false?'✗':'');
      let metr = it.metrics || {};
      // Fallback compute x and Δ% if backend didn't attach
      if ((metr == null || metr.x == null || metr.percent_time_reduction == null) && left && right && typeof left.ms==='number' && typeof right.ms==='number'){
        const A = left.ms; const T = right.ms;
        if (T>0){ metr.x = A / T; }
        if (A>0){ metr.percent_time_reduction = 100.0 * (A - T) / A; }
      }
      // Fallback compute y and z from meta or Trino stats if provided
      if ((metr == null || metr.y == null)){
        if (it.meta && it.meta.S!=null && it.meta.C!=null){
          const S = Number(it.meta.S), C = Number(it.meta.C);
          if (!isNaN(S) && !isNaN(C) && C>0){ metr.y = S / C; }
        } else {
          const bytesOf = (obj)=>{ try{ const tri=(obj&&obj.result&&obj.result.trino)||{}; return tri.processed_bytes||tri.processedBytes||tri.processed_rows||tri.processedRows; }catch{return null;} };
          const Sb = bytesOf(left);
          const Cb = bytesOf(right);
          if (Sb!=null && Cb!=null && Number(Cb)>0){ metr.y = Number(Sb)/Number(Cb); }
        }
      }
      if ((metr == null || metr.z == null) && metr && metr.x!=null && metr.y!=null){
        const xnum = Number(metr.x), ynum = Number(metr.y);
        if (!isNaN(xnum) && !isNaN(ynum)){
          metr.z = Math.pow(xnum, 1/3) * ynum;
        }
      }
      const xval = (metr && metr.x!=null && !isNaN(metr.x)) ? Number(metr.x).toFixed(3) : '';
      const yval = (metr && metr.y!=null && !isNaN(metr.y)) ? Number(metr.y).toFixed(3) : '';
      const znum = (metr && metr.z!=null && !isNaN(metr.z)) ? Number(metr.z) : null;
      const zval = (znum!=null) ? znum.toFixed(3) : '';
      const zcls = (znum==null)? '' : (znum<1? 'z-bad' : (znum>1? 'z-good' : 'z-neutral'));
      const prval = (metr.percent_time_reduction!=null && !isNaN(metr.percent_time_reduction)) ? (Number(metr.percent_time_reduction).toFixed(1) + '%') : '';
      const counts = (cmp && cmp.left_count!==undefined)? `${cmp.left_count}/${cmp.right_count}` : '';
      const schema = (cmp && cmp.same_schema===true)? '✓' : (cmp && cmp.same_schema===false ? '✗' : '');
      const tr = document.createElement('tr');
      tr.className = clsFor(it);
      const dcls = deltaClass(delta);
      const dtext = (delta===''?'':String(delta));
      tr.innerHTML = cell(it.index) +
        cell(statusFor(it)) +
        cell(ms1) +
        cell(ms2) +
        cell(`<span class=\"${dcls}\">${dtext}</span>`) +
        cell(xval) +
        cell(yval) +
        cell(`<span class=\"${zcls}\">${zval}</span>`) +
        cell(prval) +
        cell(match) +
        cell(counts) +
        cell(schema);
      tr.onclick = () => {
        $('details').textContent = JSON.stringify(it, null, 2);
        renderSteps(it.trace || []);
        // Auto-show details and steps on selection
        $('details').style.display = 'block';
        $('steps').style.display = 'block';
        // Populate SQL boxes
        const leftSql = isPair ? (it.left_sql||'') : (it.sql||'');
        const rightSql = isPair ? (it.right_sql||'') : (it.optimized_sql || it.retry_sql || '');
        $('left_sql_box').textContent = leftSql || '(нет данных)';
        $('right_sql_box').textContent = rightSql || '(нет данных)';
        // Populate result boxes
        const setPre = (id, obj) => { const el=$(id); if(!obj || Object.keys(obj).length===0){ el.textContent='(нет данных)'; } else { el.textContent = JSON.stringify(obj, null, 2);} };
        setPre('original_box', it.original);
        setPre('optimized_box', it.optimized);
        setPre('retry_box', it.retry);
        setPre('left_box', it.left);
        setPre('right_box', it.right);
        setPre('compare_box', it.compare);
      };
      rows.appendChild(tr);
    });
  }
  function renderSteps(steps){
    const container = document.getElementById('steps');
    container.innerHTML='';
    if(!steps || !steps.length){ container.textContent='Нет данных о шагах.'; return; }
    const tbl = document.createElement('table');
    tbl.innerHTML = '<thead><tr><th>#</th><th>Шаг</th><th>Время (мс)</th><th>Кратко</th><th></th></tr></thead>';
    const tb = document.createElement('tbody');
    steps.forEach((s, i)=>{
      const tr = document.createElement('tr');
      let summary = '';
      try{
        if(s.name==='schema_introspect_trino' && s.output){
          const ok = (s.output.ok===true);
          const chars = (typeof s.output.chars==='number')? s.output.chars : (s.output.schema ? String(s.output.schema).length : '');
          summary = `ok=${ok} chars=${chars}`;
        } else if ((s.name==='sql_executor' || s.name==='exec_original') && s.output){
          const ok = (s.output.ok===true);
          const rc = (s.output.rowcount!=null)? s.output.rowcount : '';
          const cols = (s.output.columns && Array.isArray(s.output.columns)) ? s.output.columns.length : '';
          const tri = s.output.trino || {};
          const src = (tri && tri.cpu_ms!=null)? 'cpu' : (tri && tri.execution_ms!=null? 'exec' : (tri && tri.elapsed_ms!=null? 'elapsed' : 'client'));
          const qid = tri.query_id || '';
          summary = `ok=${ok} rows=${rc} cols=${cols} src=${src} qid=${qid}`;
        } else if (s.name==='llm_critic') {
          const inp = s.input || {};
          const out = s.output || {};
          const route = out.route || '';
          const issues = (out.issues && Array.isArray(out.issues)) ? out.issues.length : 0;
          const uch = (inp.user_query? String(inp.user_query).length : 0);
          const sch = (inp.schema_chars!=null)? inp.schema_chars : '';
          summary = `route=${route} issues=${issues} user_query_chars=${uch} schema_chars=${sch}`;
        } else if (s.name==='enhance_prompt') {
          const inp = s.input || {};
          const out = s.output || {};
          const ep = (out.enhanced_prompt||'');
          const epc = ep.length;
          const sch = (inp.schema_chars!=null)? inp.schema_chars : '';
          summary = `enhanced_prompt_chars=${epc} issues=${inp.issues_count||0} schema_chars=${sch}`;
        } else if (s.name==='generate_sql') {
          const inp = s.input || {};
          const out = s.output || {};
          const sql = (out.sql_query||'').replace(/\s+/g,' ').trim();
          summary = sql ? (sql.length>140? sql.slice(0,140)+'…' : sql) : '';
        } else if (s.name==='fix_error_prompt') {
          const inp = s.input || {};
          const out = s.output || {};
          const fp = (out.fixed_prompt||'');
          const rpc = fp.length;
          summary = `fixed_prompt_chars=${rpc}`;
        } else {
          summary = (s.output && typeof s.output === 'object') ? JSON.stringify(s.output).slice(0,140) + '…' : String(s.output);
        }
      } catch(e){
        summary = (s.output && typeof s.output === 'object') ? JSON.stringify(s.output).slice(0,140) + '…' : String(s.output);
      }
      const rowId = `step_${i}`;
      const src = (s && s.name==='sql_executor' && s.output && s.output.trino) ? ((s.output.trino.execution_ms!=null)?'exec':(s.output.trino.elapsed_ms!=null?'elapsed':'client')) : '';
      const msCell = (s.ms!=null) ? `${s.ms} ${src?`(${src})`:''}` : '';
      tr.innerHTML = `<td>${i+1}</td><td>${s.name}</td><td>${msCell}</td>`+
        `<td><pre style="white-space:pre-wrap"></pre></td>`+
        `<td><button onclick="toggleBox('${rowId}')">Детали</button></td>`;
      // Заполняем summary безопасно (textContent), чтобы не парсилось как HTML
      try { tr.querySelector('pre').textContent = summary; } catch(e) {}
      const detailsTr = document.createElement('tr');
      const detailsTd = document.createElement('td');
      detailsTd.colSpan = 5;
      const pre = document.createElement('pre');
      pre.id = rowId;
      pre.style.display = 'none';
      pre.style.whiteSpace = 'pre-wrap';
      try {
        pre.textContent = (typeof s.output==='object'?JSON.stringify(s.output,null,2):String(s.output));
      } catch(e) {
        pre.textContent = String(s.output);
      }
      detailsTd.appendChild(pre);
      detailsTr.appendChild(detailsTd);
      tb.appendChild(tr);
      tb.appendChild(detailsTr);
    });
    tbl.appendChild(tb);
    container.appendChild(tbl);
  }
  function toggleBox(id){ const el=$(id); el.style.display = (el.style.display==='none' || !el.style.display) ? 'block' : 'none'; }
  async function poll(){
    const r = await fetch(`/jobs/${jobId}`);
    if(r.status===404){ $('meta').textContent = 'Джоба не найдена'; return; }
    const j = await r.json();
    render(j);
    if(j.status!=='finished') setTimeout(poll, 1200);
  }
  window.addEventListener('DOMContentLoaded', poll);
</script>
{% endblock %}
